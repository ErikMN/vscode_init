#!/usr/bin/env bash
set -eu

DEBUG=false

# Print colors:
FMT_RED=$(printf '\033[31m')
FMT_GREEN=$(printf '\033[32m')
FMT_BLUE=$(printf '\033[34m')
FMT_YELLOW=$(printf '\033[33m')
FMT_WHITE=$(printf '\033[37m')
FMT_BOLD=$(printf '\033[1m')
FMT_RESET=$(printf '\033[0m')

if [ $# -eq 0 ]; then
  echo "Please specify the project directory:"
  echo "${FMT_BLUE}  $(basename $0) ${FMT_GREEN}<project-directory>${FMT_RESET}"
  echo
  echo "For example:"
  echo "${FMT_BLUE}  $(basename $0) ${FMT_GREEN}my-app${FMT_RESET}"
  exit 0
else
  APP=$1
fi

# Default template:
PROJECT_DESCRIPTION=C
TEMPLATE_DIR=tpl_c_make
TEMPLATE="${TEMPLATE:-}"

# Set template from env:
if [ "$TEMPLATE" = cpp ]; then
  PROJECT_DESCRIPTION=C++
  TEMPLATE_DIR=tpl_cpp_make
elif [ "$TEMPLATE" = sharedlib ]; then
  PROJECT_DESCRIPTION="shared library C"
  TEMPLATE_DIR=tpl_c_lib_make
fi

VSCODE="command -v code >/dev/null 2>&1"
GIT="command -v git >/dev/null 2>&1"
OS=$(uname)

realpath_macos() {
  [[ $1 = /* ]] && echo "$1" || echo "$PWD/${1#./}"
}

if [ "$OS" = "Darwin" ]; then
  PROJECT_DIR=$(realpath_macos "$APP")
else
  PROJECT_DIR=$(realpath "$APP")
fi

APP=$(basename "${APP}")
BASEDIR=$(dirname "$0")
VSCODE_INIT_DIR="$BASEDIR/../share/vscode_init"

if [ "$DEBUG" = true ]; then
  printf "APP:                  %s\n" "$APP"
  printf "PROJECT_DIR:          %s\n" "$PROJECT_DIR"
  printf "BASEDIR:              %s\n" "$BASEDIR"
  printf "VSCODE_INIT_DIR:      %s\n" "$VSCODE_INIT_DIR"
  printf "TEMPLATE_DIR:         %s\n" "$TEMPLATE_DIR"
  printf "PROJECT_DESCRIPTION:  %s\n" "$PROJECT_DESCRIPTION"
  printf "\n"
fi

if [ -d "$PROJECT_DIR" ]; then
  echo "${FMT_RED}*** Error: '$PROJECT_DIR' already exists... exit${FMT_RESET}"
  exit 1
fi

SUPPORTED="2.28.0"
GIT_VERSION=$(git --version | cut -d' ' -f3)

# Silence git:
q_git() {
  git "$@" >/dev/null
}

# Initialize a git repo with an initial commit (git < 2.28.0 does not support 'git init -b <name>'):
GIT_INIT_REPO() {
  if ! $GIT > /dev/null; then
    echo "${FMT_RED}*** Git is not installed: skipping setup repo${FMT_RESET}"
    return
  fi
  if (( $(echo $GIT_VERSION $SUPPORTED | awk '{print ($1 >= $2)}') )); then
    q_git init -b main
  else
    q_git init && q_git checkout -b main
  fi
  q_git add -A && q_git commit -m "Initial commit"
}

# Create a C project with vscode tasks in the provided directory:
SETUP_PROJECT() {
  echo "${FMT_BOLD}*** Initializing $PROJECT_DESCRIPTION project '$APP' in $(dirname "$PROJECT_DIR")${FMT_RESET}"
  mkdir -p "$PROJECT_DIR" &&
  cp -r "$VSCODE_INIT_DIR/$TEMPLATE_DIR/." "$PROJECT_DIR/" &&
  mkdir -p "$PROJECT_DIR/.vscode" &&
  cp "$VSCODE_INIT_DIR/vscode/"*.json "$PROJECT_DIR/.vscode/" &&
  sed -i.bak "s/xxxxxxxxx/$APP/g" "$PROJECT_DIR/Makefile" "$PROJECT_DIR/.gitignore" &&
  cd "$PROJECT_DIR/" &&
  rm *.bak .*.bak &&
  GIT_INIT_REPO
}

# Start Visual Studio Code if it is installed:
START_VSCODE() {
  if $VSCODE > /dev/null; then
    echo "${FMT_BLUE}*** Starting Visual Studio Code${FMT_RESET}"
    code "$PROJECT_DIR"
  else
    echo "${FMT_RED}*** Visual Studio Code is not installed${FMT_RESET}"
  fi
}

# Execute setup functions:
SETUP_PROJECT
START_VSCODE
echo "${FMT_BOLD}${FMT_GREEN}*** Project created in:" ${FMT_WHITE}"$PROJECT_DIR${FMT_RESET}"
